# LlamaIndex 完整教學指南

## 概述

LlamaIndex 是一個強大的 RAG（Retrieval-Augmented Generation）框架，專門用於建立智能文件檢索和問答系統。本教學指南將帶您從基礎到進階，完整掌握 LlamaIndex 的核心功能。

## 學習路徑

### 基礎階段（01-04）

#### 01_basic_setup.py - 環境設定與基礎概念
**學習目標：**
- 了解 LlamaIndex 的核心概念
- 設定開發環境
- 掌握基本的 LLM 和嵌入模型配置

**核心概念：**
- Document：原始文件
- Node：文件分割後的小塊
- Index：向量索引
- Retriever：檢索器
- Query Engine：查詢引擎

**實作重點：**
```python
# 設定 LLM 和嵌入模型
llm = OpenAI(model="gpt-3.5-turbo", temperature=0.1)
embed_model = OpenAIEmbedding(model="text-embedding-3-small")

# 全域設定
Settings.llm = llm
Settings.embed_model = embed_model
```

#### 02_document_loading.py - 文件載入與處理
**學習目標：**
- 掌握多種文件載入方式
- 了解文件處理流程
- 學習文件分割策略

**支援的文件格式：**
- 文字檔案（.txt, .md）
- PDF 文件
- Word 文件（.docx）
- 網頁內容
- 自定義文件

**實作重點：**
```python
# 從資料夾載入文件
reader = SimpleDirectoryReader(input_dir="documents")
documents = reader.load_data()

# 自定義文件
custom_doc = Document(
    text="文件內容",
    metadata={"source": "manual", "author": "user"}
)
```

#### 03_vector_index.py - 向量索引建立
**學習目標：**
- 建立不同類型的向量索引
- 了解向量儲存選項
- 掌握索引持久化

**索引類型：**
- VectorStoreIndex：向量索引（最常用）
- SummaryIndex：摘要索引
- TreeIndex：樹狀索引
- KeywordTableIndex：關鍵字索引

**向量儲存選項：**
- SimpleVectorStore：記憶體儲存
- ChromaVectorStore：ChromaDB
- PineconeVectorStore：Pinecone
- FaissVectorStore：Facebook AI

**實作重點：**
```python
# 基本索引
index = VectorStoreIndex.from_documents(documents)

# 持久化索引
index = VectorStoreIndex.from_documents(
    documents,
    storage_context=StorageContext.from_defaults(persist_dir="./storage")
)

# ChromaDB 索引
vector_store = ChromaVectorStore(chroma_collection=collection)
index = VectorStoreIndex.from_documents(
    documents,
    storage_context=StorageContext.from_defaults(vector_store=vector_store)
)
```

#### 04_query_retrieval.py - 查詢與檢索
**學習目標：**
- 掌握不同的檢索策略
- 了解查詢引擎類型
- 學習檢索優化技巧

**檢索策略：**
- 向量相似性檢索
- 關鍵字檢索
- 混合檢索
- 重新排序檢索

**查詢引擎類型：**
- 標準查詢引擎
- 檢索器查詢引擎
- 摘要查詢引擎
- 樹狀查詢引擎

**實作重點：**
```python
# 基本查詢
query_engine = index.as_query_engine()
response = query_engine.query("問題")

# 進階檢索
retriever = VectorIndexRetriever(index=index, similarity_top_k=5)
query_engine = RetrieverQueryEngine.from_args(retriever=retriever)

# 相似度過濾
similarity_filter = SimilarityPostprocessor(similarity_cutoff=0.7)
query_engine = RetrieverQueryEngine.from_args(
    retriever=retriever,
    node_postprocessors=[similarity_filter]
)
```

### 進階階段（05-08）

#### 05_rag_integration.py - RAG 系統整合
**學習目標：**
- 建立完整的 RAG 系統
- 掌握提示詞工程
- 學習系統優化策略

**RAG 組件：**
- 文件載入器
- 文字分割器
- 嵌入模型
- 向量儲存
- 檢索器
- 生成模型

**優化策略：**
- 檢索優化
- 生成優化
- 儲存優化
- 流程優化

**實作重點：**
```python
# 自定義提示詞
custom_prompt = PromptTemplate("""
你是一個專業顧問，請根據以下上下文回答問題。

上下文：{context_str}
問題：{query_str}

請提供詳細回答。
""")

query_engine = index.as_query_engine(text_qa_template=custom_prompt)

# 多文件 RAG
sub_question_engine = SubQuestionQueryEngine.from_defaults(
    query_engine_tools=[query_engine_tool]
)
```

#### 06_agent_integration.py - 與 Agent SDK 整合
**學習目標：**
- 將 LlamaIndex 整合到 Agent 系統
- 創建智能工具
- 實現多代理協作

**整合優勢：**
- 強大的檢索能力
- 智能工具使用
- 專業化分工
- 靈活的工作流程

**實作重點：**
```python
@function_tool
def search_documents(query: str, top_k: int = 3) -> str:
    """在知識庫中搜尋相關內容"""
    query_engine = index.as_query_engine(similarity_top_k=top_k)
    response = query_engine.query(query)
    return response.response

# 創建智能代理
smart_agent = Agent(
    name="KnowledgeAssistant",
    instructions="你是知識助手，可以搜尋和分析文件內容。",
    tools=[search_documents]
)
```

#### 07_advanced_features.py - 進階功能
**學習目標：**
- 掌握自定義節點解析器
- 了解進階檢索器
- 學習後處理器使用

**進階功能：**
- 自定義節點解析器
- 進階檢索器
- 後處理器
- 向量資料庫整合
- 混合搜尋
- 自定義嵌入
- 元數據管理
- 串流處理

**實作重點：**
```python
# 自定義分割器
custom_splitter = SentenceSplitter(
    chunk_size=512,
    chunk_overlap=100,
    separator="。"
)

# 進階檢索器
vector_retriever = VectorIndexRetriever(
    index=index,
    similarity_top_k=5
)

# 後處理器
similarity_filter = SimilarityPostprocessor(similarity_cutoff=0.7)
keyword_filter = KeywordNodePostprocessor(
    required_keywords=["關鍵字1", "關鍵字2"]
)
```

#### 08_production_deployment.py - 生產環境部署
**學習目標：**
- 了解生產環境考量
- 掌握監控和日誌
- 學習效能優化

**生產環境考量：**
- 架構設計
- 資料管理
- 安全性
- 監控與日誌
- 效能優化
- 部署與維護
- 擴展性

**實作重點：**
```python
class ProductionRAGSystem:
    def __init__(self, config):
        self.config = config
        self.metrics = {
            "total_queries": 0,
            "successful_queries": 0,
            "average_response_time": 0.0
        }
        self._setup_system()
    
    def query(self, question: str):
        start_time = time.time()
        try:
            response = self.query_engine.query(question)
            self._update_metrics(time.time() - start_time, success=True)
            return {"success": True, "response": response.response}
        except Exception as e:
            self._update_metrics(time.time() - start_time, success=False)
            return {"success": False, "error": str(e)}
```

## 最佳實踐

### 1. 文件處理
- 選擇合適的分割策略
- 控制塊大小和重疊
- 保留重要的元數據

### 2. 索引建立
- 根據資料量選擇向量儲存
- 實施索引壓縮
- 定期更新索引

### 3. 查詢優化
- 調整相似度閾值
- 使用混合檢索策略
- 實施快取機制

### 4. 系統監控
- 追蹤查詢效能
- 監控錯誤率
- 分析使用者回饋

### 5. 安全性
- 實施 API 認證
- 驗證輸入資料
- 加密敏感資訊

## 常見問題與解決方案

### Q1: 如何處理大文件？
**解決方案：**
- 使用適當的分割策略
- 實施分塊索引
- 考慮使用分散式儲存

### Q2: 如何提高檢索準確性？
**解決方案：**
- 調整相似度閾值
- 使用混合檢索
- 實施重新排序

### Q3: 如何優化查詢速度？
**解決方案：**
- 使用快取機制
- 優化索引結構
- 實施並行處理

### Q4: 如何處理多語言文件？
**解決方案：**
- 使用多語言嵌入模型
- 實施語言檢測
- 考慮語言特定的分割策略

## 延伸學習

### 1. 多模態 RAG
- 圖片和文字結合
- 音頻文件處理
- 視覺問答系統

### 2. 分散式 RAG
- 多節點部署
- 負載均衡
- 資料同步

### 3. 自定義檢索器
- 領域特定檢索
- 混合檢索策略
- 學習式檢索

### 4. 評估與優化
- RAG 評估指標
- A/B 測試
- 持續改進

## 總結

LlamaIndex 是一個功能強大的 RAG 框架，提供了從文件處理到生產部署的完整解決方案。通過本教學指南的學習，您將能夠：

1. 建立高效的 RAG 系統
2. 整合到 Agent 架構中
3. 部署到生產環境
4. 持續優化和改進

記住，RAG 系統的成功不僅在於技術實現，更在於對業務需求的理解和持續的優化改進。祝您學習愉快！